generator client {
  provider      = "prisma-client"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Performer {
  id        String   @id @default(uuid())
  key       String   @unique
  createdAt DateTime @default(now())

  chats Chat[]

  @@map("performers")
}

model Guest {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  createdAt    DateTime @default(now())

  chats Chat[]

  @@map("guests")
}

model Chat {
  id        String     @id @default(uuid())
  title     String
  status    ChatStatus @default(WAITING)
  createdAt DateTime   @default(now())
  assumedAt DateTime?
  updatedAt DateTime   @default(now()) @updatedAt

  guestId String
  guest   Guest  @relation(fields: [guestId], references: [id])

  performerId String?
  performer   Performer? @relation(fields: [performerId], references: [id])

  messages          Message[]
  lastMessageSender MessageSender

  @@index([status])
  @@index([guestId])
  @@index([performerId])
  @@map("chats")
}

model Message {
  id      Int           @id @default(autoincrement())
  content String
  sender  MessageSender
  sentAt  DateTime      @default(now())

  chatId String
  chat   Chat   @relation(fields: [chatId], references: [id])

  @@index([chatId, sentAt])
  @@map("messages")
}

enum MessageSender {
  GUEST
  PERFORMER
}

enum ChatStatus {
  WAITING
  IN_PROGRESS
}
